user root;
# 1. Usa todos los núcleos disponibles para repartir la carga del SSL
worker_processes auto; 

pid /tmp/nginx.pid;
error_log /dev/stderr warn;

events {
    # Aumentamos conexiones para aguantar benchmarks pesados
    worker_connections 2048;
    multi_accept on;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;
    
    # 2. Optimizaciones de red
    sendfile        on;
    tcp_nopush      on;
    tcp_nodelay     on;
    
    # Mantenemos la conexión abierta para que 'ab -k' funcione
    keepalive_timeout  65;
    keepalive_requests 1000;

    # 3. Caché de Sesiones SSL (VITAL para no repetir el handshake caro)
    ssl_session_cache   shared:SSL:10m;
    ssl_session_timeout 10m;
    ssl_session_tickets off;

    access_log /dev/stdout;

    server {
        listen 443 ssl;
        server_name localhost;

        # Certificados (Ed25519)
        ssl_certificate     /etc/nginx/certs/server.crt;
        ssl_certificate_key /etc/nginx/certs/server.key;
        
        # 4. Ajuste para Ed25519 y TLS 1.3 (Máxima eficiencia)
        # Forzamos TLS 1.3 para que coincida con la modernidad de Ed25519
        ssl_protocols       TLSv1.2 TLSv1.3;
        
        # En TLS 1.3 el orden de ciphers no es tan rígido, pero añadimos soporte EdDSA
        ssl_ciphers 'TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-ECDSA-CHACHA20-POLY1305';
        
        # Importante: Habilitar curvas modernas para el intercambio de llaves
        ssl_ecdh_curve      X25519:P-256:P-384;
        
        ssl_prefer_server_ciphers off;

        root /usr/share/nginx/html;
        index index.html;

        location / {
            try_files $uri $uri/ /index.html;
        }

        location ~* \.wasm$ {
            add_header Content-Type application/wasm;
        }

        # Tu módulo de C
        location /api {
            hola_mundo_dispatcher; 
        }
    }

    # Servidor HTTP para pruebas de benchmark sin SSL (Velocidad Pura)
    server {
        listen 80;
        server_name localhost;
        
        location /api {
            hola_mundo_dispatcher;
        }
    }
}